# Project: vol_plugins
# Filename: dll_path.py
# Created on 19.11.17 by francesco
# Last modified on 19.11.17 by francesco

import json
import sys


def dlllpath(json_file):
    print("# DLL PATH - DLL INJECTION #")
    print("############################")
    print("Looking for DLL injections by comparing dll path to known legit paths")
    print("")
    print("Opening json dump of dlllist: {}".format(json_file))
    print("")
    with open(json_file) as file:
        dlllist = json.load(file)

    columns = {}
    i = 0
    for column in dlllist['columns']:
        columns[column] = i
        i += 1

    legit_paths = [
        'windows',
        'system32',
        'program files'
    ]
    for row in dlllist['rows']:
        pid = row[columns['Pid']]
        path = row[columns['Path']]
        try:
            path_root = path.split('\\')[1]  # eg. C:\\WINDOWS\\system32\\WSOCK32.dll --> WINDOWS
            if path_root.lower() not in legit_paths:
                print("Possible DLL injection:\n\tPID: {0}\n\tDLL Path: {1}".format(pid, path))
        except IndexError:
            pass


if __name__ == '__main__':
    n_args = len(sys.argv)
    if n_args == 1:
        print("Please specify path of json output of dlllist (--output=json)")
    elif n_args == 2:
        json_path = sys.argv[1]
        dlllpath(json_path)
    else:
        print("Wrong number of parameters specified")
