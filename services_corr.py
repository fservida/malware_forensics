# Project: vol_plugins
# Filename: services_corr.py
# Created on 03.12.17 by francesco
# Last modified on 03.12.17 by francesco

import json
import sys


def corr_services(printkey_json_file, services_json_file):
    print()
    print("# Services - Registry correlation #")
    print("###################################")
    print("Looking for correlations btw services and registry")
    print("")
    print("Opening json dump of printkey: {}".format(printkey_json_file))
    print("Opening json dump of svcscan: {}".format(services_json_file))
    print("")
    with open(printkey_json_file) as file:
        printkey = json.load(file)
    with open(services_json_file) as file:
        svcscan = json.load(file)

    printkey_columns = {}
    i = 0
    for column in printkey['columns']:
        printkey_columns[column] = i
        i += 1

    svcscan_columns = {}
    i = 0
    for column in svcscan['columns']:
        svcscan_columns[column] = i
        i += 1

    svcscan_names = {}
    for row in svcscan['rows']:
        pass

    services_reg = [row[printkey_columns['Subkeys']].lower() for row in printkey['rows']]
    services_scan = {row[svcscan_columns['ServiceName']].lower():row for row in svcscan['rows']}

    for service in services_reg:
        if service not in services_scan:
            print("Found a service not present in the service list: ", service)


if __name__ == '__main__':
    n_args = len(sys.argv)
    if n_args == 1 or n_args == 2:
        print("Please specify path of json output of printkey and services (in this order) (--output=json)")
    elif n_args == 3:
        registry_services = sys.argv[1]
        svcscan = sys.argv[2]
        corr_services(registry_services, svcscan)
    else:
        print("Wrong number of parameters specified")
